---
title: "covid_analysis"
output: html_document
date: "2022-09-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyverse)
library(lubridate)
library(dplyr)
library(writexl)

```

```{r}
data <- read_csv('data.csv')
colnames(data) <- c('drop','type','role','date','count')
data <- 
  data%>% 
drop_na(drop)
data <- subset(data, select = -c(drop))


#clean date
data$date <- as.Date(parse_date_time(data$date, "dmy"))
data$year <- as.numeric(format(data$date, "%Y"))


```

```{r}
#create dfs by semester
fall2020 <- data[data$date >= "2020-08-30" & data$date <= "2020-12-22", ]
spring2021 <- data[data$date >= "2021-01-25" & data$date <= "2021-05-19", ]
fall2021 <- data[data$date >= "2021-08-30" & data$date <= "2021-12-22", ]
spring2022  <- data[data$date >= "2022-01-24" & data$date <= "2022-05-18", ]
fall2022  <- data[data$date >= "2022-08-29",]


#devon semesters - adjust start date for fall 2020, end date for fall 2021
d_fall2020 <- data[data$date >= "2020-08-31" & data$date <= "2020-12-22", ]
d_spring2021 <- data[data$date >= "2021-01-25" & data$date <= "2021-05-19", ]
d_fall2021 <- data[data$date >= "2021-08-30" & data$date <= "2021-12-21", ]
d_spring2022  <- data[data$date >= "2022-01-24" & data$date <= "2022-05-18", ]
d_fall2022  <- data[data$date >= "2022-08-29",]

```

```{r}
sum(fall2020$count)
sum(spring2021$count)
sum(fall2021$count)
sum(spring2022$count)
sum(fall2022$count)

#devon sums with new adjusted semesters
sum(d_fall2020$count)
sum(d_spring2021$count)
sum(d_fall2021$count)
sum(d_spring2022$count)
sum(d_fall2022$count)

```

```{r}
shortfall2020 <- data[data$date >= "2020-08-30" & data$date <= "2020-09-21", ]
shortspring2021 <- data[data$date >= "2021-01-25" & data$date <= "2021-02-10", ] #why is this shorter? - devon
shortfall2021 <- data[data$date >= "2021-08-30" & data$date <= "2021-09-21", ]
shortspring2022  <- data[data$date >= "2022-01-24" & data$date <= "2022-02-11", ] #why is this shorter? - devon
fall2022  <- data[data$date >= "2022-08-29",]

#devon short sems adjusting fall 2020 start, spring 2021 end, fall 2021 end, spring 2022 end
d_shortfall2020 <- data[data$date >= "2020-08-31" & data$date <= "2020-09-21", ]
d_shortspring2021 <- data[data$date >= "2021-01-25" & data$date <= "2021-02-15", ]
d_shortfall2021 <- data[data$date >= "2021-08-30" & data$date <= "2021-09-20", ]
d_shortspring2022  <- data[data$date >= "2022-01-24" & data$date <= "2022-02-14", ]
d_fall2022  <- data[data$date >= "2022-08-29",]
```

```{r}
sum(shortfall2020$count)
sum(shortspring2021$count)
sum(shortfall2021$count)
sum(shortspring2022$count)
sum(fall2022$count)

#devon sums with adjusted semesters
sum(d_shortfall2020$count)
sum(d_shortspring2021$count)
sum(d_shortfall2021$count)
sum(d_shortspring2022$count)
sum(d_fall2022$count)
```

```{r}
library(ggplot2)
```

```{r}
ggplot(data=data, aes(x=date, y=count, group=1)) +
  geom_line()+
  geom_point()
```

```{r}
databydate <- data %>% group_by(date)
databydate <- subset(databydate, select = -c(role))


shortfall2020sr <- 
  shortfall2020%>%
  filter(type == "Self Reported")

shortspring2021sr <- 
  shortspring2021%>%
  filter(type == "Self Reported")

shortfall2021sr <- 
  shortfall2021%>%
  filter(type == "Self Reported")

shortspring2022sr <- 
  shortspring2022%>%
  filter(type == "Self Reported")

fall2022sr <- 
  fall2022%>%
  filter(type == "Self Reported")



```

```{r}
sum(fall2020sr$count)
sum(spring2021sr$count)
sum(fall2021sr$count)
sum(spring2022sr$count)
sum(fall2022sr$count)



```


```{r}
sum(fall2020sr$count)
sum(spring2021sr$count)
sum(fall2021sr$count)
sum(spring2022sr$count)
sum(fall2022sr$count)
```

```{r}

shortfall2020u <- 
  shortfall2020%>%
  filter(type =="UHC Reported")

shortspring2021u <- 
  shortspring2021%>%
  filter(type == "UHC Reported")

shortfall2021u <- 
  shortfall2021%>%
  filter(type == "UHC Reported")

shortspring2022u <- 
  shortspring2022%>%
  filter(type == "UHC Reported")

fall2022u <- 
  fall2022%>%
  filter(type == "UHC Reported")

```

```{r}
sum(fall2020u$count)
sum(spring2021u$count)
sum(fall2021u$count)
sum(spring2022u$count)
sum(fall2022u$count)
```


```{r}
sum(fall2020u$count) + sum(fall2020sr$count)
sum(shortspring2021u$count) + sum(shortspring2021sr$count)
sum(shortfall2021u$count)+sum(shortfall2021sr$count)
sum(shortspring2022u$count)+sum(shortspring2022sr$count)

sum(fall2022u$count)+sum(fall2022sr$count)

```

Pivoting, binding, and cleaning data here -- Shreya 
```{r}

#load in data
data <- read_csv('data.csv') %>%
  clean_names() %>%
  rename(
    date = positive_test_result_date
  ) %>%
  drop_na(question_from_laura) #%>%
  # mutate(
  #   number_of_cases = as.double(number_of_cases)
  # )

#clean date
data$date <- as.Date(parse_date_time(data$date, "dmy"))
data$year <- as.numeric(format(data$date, "%Y"))

clean_historic_data <- data %>%
  pivot_wider(names_from=primary_role, values_from=number_of_cases, values_fn = list, values_fill = 0) %>%
  clean_names() %>%
  mutate(
    student = as.character(student)
  )
  #mutate(across(student:faculty, ~replace(., lengths(.) == 0, NA))) 

#export to excel because efficiency and I don't know how
write_xlsx(clean_historic_data, "clean_historic_data.xlsx")

self_reports_clean <- clean_historic_data %>%
  filter(self_reported_or_uhc_reported == "Self Reported") 

# test
fall2020 <- clean_historic_data[clean_historic_data$date >= "2020-08-30" & clean_historic_data$date <= "2020-12-22", ]
self_reports_clean[is.null(self_reports_clean)] = 0


uhc_reports_clean <- clean_historic_data %>%
  filter(self_reported_or_uhc_reported == "UHC Reported")

```


Joining the important policy dates to case -- Shreya
```{r}

library(readxl)

#load in data
new_data <- read_xlsx("data_09_30.xlsx") %>%
  clean_names() %>%
  rename(
    date = positive_test_result_date
  ) 


### policy dates
historic_dates <- read_csv("historical_covid_dates.csv") %>%
  select(dates, what_happened) %>%
  rename(
    date = dates
  )


##pivoted data
join_dates_and_cases <- new_data %>%
  left_join(historic_dates, by=c("date")) %>%
  pivot_wider(names_from=primary_role, values_from=no_of_cases) %>%
  clean_names() 

##wider for fun
wide_join_dates_and_cases <- new_data %>%
  left_join(historic_dates, by=c("date")) %>%
  select(-diamondback_request) %>%
  group_by(reporting_type) %>%
  pivot_wider(names_from=c("primary_role", "reporting_type"), values_from=no_of_cases) %>%
  clean_names() %>%
  mutate_at(c(3:8), ~replace_na(.,0))

  
write_xlsx(join_dates_and_cases, "join_dates_and_cases.xlsx")

write_xlsx(wide_join_dates_and_cases, "wide_join_dates_and_cases.xlsx")



```

