---
title: "clean_ledger_data"
author: "Devon Milley"
date: "2023-03-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(dplyr)
library(janitor)
library(lubridate)
library(tidytext)
library(readxl)
library(writexl)

```

#load data
```{r}
#load data
ledger_2017 <- read_excel("ledger_data/2017.xls") 
ledger_2018 <- read_excel("ledger_data/2018.xls")
ledger_2019 <- read_excel("ledger_data/2019.xls")
ledger_2020 <- read_excel("ledger_data/2020.xls")
ledger_2021 <- read_excel("ledger_data/2021.xls")
ledger_2022 <- read_excel("ledger_data/2022.xlsx")
```

#fix
```{r}
#combine 2017-2020 and 2022 and fix
ledger_17_18 <- rbind(ledger_2017, ledger_2018)

ledger_17_18_19 <- rbind(ledger_17_18, ledger_2019)

ledger_17_18_19_20 <- rbind(ledger_17_18_19, ledger_2020) %>% 
  mutate(
    "Organization Name" = ""
  ) 

ledger_17_18_19_20_21 <- rbind(ledger_17_18_19_20, ledger_2021)

ledger_all <- rbind(ledger_17_18_19_20_21, ledger_2022) %>% 
  clean_names()

ledger_all_distinct <- ledger_all %>% 
  clean_names() %>% 
  group_by(po_number, vendor_name, vendor_address_1, vendor_address_2, vendor_city, vendor_state, vendor_country, vendor_zip, po_date, item_ld, item_order_qty, grand_total_amt, organization_name) %>% 
  distinct()

#what is getting distincted out -- this isnt working rawr DM
ledger_all_hm <- ledger_all_distinct %>% 
  anti_join(ledger_all, by=c("po_number", "vendor_name", "vendor_address_1", "vendor_address_2","vendor_city", "vendor_state", "vendor_country", "vendor_zip", "po_date", "item_ld", "item_order_qty", "grand_total_amt", "organization_name"))


#continue fixing
ledger_all_clean <- ledger_all_distinct %>% 
  ungroup() %>% 
  group_by(po_number, po_date, grand_total_amt) %>% 
  mutate(
    item_count = paste0("count_",row_number())
  ) %>% 
  unite("item_ld_qty", c("item_ld", "item_order_qty"), sep=",") %>% 
  pivot_wider(names_from = item_count, values_from = item_ld_qty) %>% 
  unite(col="items_qty", c(starts_with("count_")), sep=";", na.rm=TRUE) %>% 
  relocate(
    items_qty, .before = grand_total_amt
  )



write.csv(ledger_all_clean, file = 'ledger_all_clean.csv')


```

